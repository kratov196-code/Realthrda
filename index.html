
<!DOCTYPE html>
<html>
<head>
    <title>–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ —Ç–µ—Å—Ç CryptoCat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .video-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .video-box {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        video {
            width: 100%;
            height: 400px;
            background: black;
            border-radius: 5px;
        }
        .controls {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .btn {
            padding: 12px 25px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .code-box {
            margin-top: 20px;
            border: 2px dashed #ccc;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            display: none;
        }
        textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        .hint {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        .code-controls {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìπ –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ —Å –¥—Ä—É–≥–æ–º</h1>
        
        <div class="video-grid">
            <div class="video-box">
                <h3>üë§ –í—ã</h3>
                <video id="localVideo" autoplay muted playsinline></video>
            </div>
            <div class="video-box">
                <h3>üë• –î—Ä—É–≥</h3>
                <video id="remoteVideo" autoplay playsinline></video>
            </div>
        </div>
        
        <div class="controls">
            <h2>üöÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–º</h2>
            
            <div>
                <button class="btn btn-primary" onclick="startCall()">
                    üìû –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫
                </button>
                <button class="btn btn-success" onclick="answerCall()">
                    ‚úÖ –ü—Ä–∏–Ω—è—Ç—å –∑–≤–æ–Ω–æ–∫
                </button>
            </div>
            
            <div id="offerBox" class="code-box">
                <h3>1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ –¥—Ä—É–≥—É:</h3>
                <textarea id="offerText" readonly></textarea>
                <div class="code-controls">
                    <button class="btn btn-secondary" onclick="copyOffer()">
                        üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <span class="hint">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –≤—ã—à–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥—É –ª—é–±—ã–º —Å–ø–æ—Å–æ–±–æ–º</span>
                </div>
            </div>
            
            <div id="answerBox" class="code-box">
                <h3>2. –í—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–≤–µ—Ç –æ—Ç –¥—Ä—É–≥–∞:</h3>
                <textarea id="answerText" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤–∞–º –æ—Ç–ø—Ä–∞–≤–∏–ª –¥—Ä—É–≥..."></textarea>
                <div class="code-controls">
                    <button class="btn btn-success" onclick="submitAnswer()">
                        üöÄ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                    </button>
                </div>
            </div>
            
            <div id="status" class="status"></div>
        </div>
    </div>
    
    <script>
        let localStream;
        let peerConnection;
        let currentOffer = null;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
        function showStatus(message, isSuccess = true) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status ' + (isSuccess ? 'status-success' : '');
            statusEl.style.display = 'block';
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
        
        // 1. –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫
        async function startCall() {
            try {
                // –ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 },
                    audio: false 
                });
                
                // –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                document.getElementById('localVideo').srcObject = localStream;
                showStatus('‚úÖ –ö–∞–º–µ—Ä–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞');
                
                // –°–æ–∑–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ WebRTC
                createPeerConnection();
                
                // –°–æ–∑–¥–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
                currentOffer = offer;
                
                // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                document.getElementById('offerText').value = JSON.stringify(offer, null, 2);
                document.getElementById('offerBox').style.display = 'block';
                document.getElementById('answerBox').style.display = 'block';
                
                showStatus('‚úÖ –°–æ–∑–¥–∞–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥—É');
                
            } catch (error) {
                showStatus('‚ùå –û—à–∏–±–∫–∞: ' + error.message, false);
            }
        }
        
        // 2. –ü—Ä–∏–Ω—è—Ç—å –∑–≤–æ–Ω–æ–∫
        async function answerCall() {
            try {
                // –ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 },
                    audio: false 
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                showStatus('‚úÖ –ö–∞–º–µ—Ä–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞');
                
                // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
                document.getElementById('answerBox').style.display = 'block';
                document.getElementById('answerText').focus();
                
                showStatus('‚úÖ –í—Å—Ç–∞–≤—å—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç –¥—Ä—É–≥–∞ –≤ –ø–æ–ª–µ –≤—ã—à–µ');
                
            } catch (error) {
                showStatus('‚ùå –û—à–∏–±–∫–∞: ' + error.message, false);
            }
        }
        
        // 3. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –¥—Ä—É–≥–∞
        async function submitAnswer() {
            try {
                const answerText = document.getElementById('answerText').value.trim();
                if (!answerText) {
                    showStatus('‚ùå –í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –¥—Ä—É–≥–∞', false);
                    return;
                }
                
                const answer = JSON.parse(answerText);
                
                if (!peerConnection) {
                    createPeerConnection();
                }
                
                // –ï—Å–ª–∏ —É –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–º—ã –∑–≤–æ–Ω–∏–≤—à–∏–π)
                if (peerConnection.localDescription) {
                    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –¥—Ä—É–≥–∞
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                    showStatus('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω');
                } else {
                    // –ï—Å–ª–∏ –º—ã –ø—Ä–∏–Ω–∏–º–∞—é—â–∏–π –∑–≤–æ–Ω–æ–∫
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                    const localAnswer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(localAnswer);
                    
                    // –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ
                    document.getElementById('offerText').value = JSON.stringify(localAnswer, null, 2);
                    document.getElementById('offerBox').style.display = 'block';
                    showStatus('‚úÖ –û—Ç–≤–µ—Ç —Å–æ–∑–¥–∞–Ω. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ–±—Ä–∞—Ç–Ω–æ –¥—Ä—É–≥—É');
                }
                
            } catch (error) {
                showStatus('‚ùå –û—à–∏–±–∫–∞: ' + error.message, false);
            }
        }
        
        // 4. –°–æ–∑–¥–∞—Ç—å WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        function createPeerConnection() {
            const config = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            };
            
            peerConnection = new RTCPeerConnection(config);
            
            // –î–æ–±–∞–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            // –ü–æ–ª—É—á–∏—Ç—å –≤–∏–¥–µ–æ –æ—Ç –¥—Ä—É–≥–∞
            peerConnection.ontrack = (event) => {
                if (document.getElementById('remoteVideo').srcObject) return;
                document.getElementById('remoteVideo').srcObject = event.streams[0];
                showStatus('‚úÖ –í–∏–¥–µ–æ –¥—Ä—É–≥–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ!');
            };
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ (–¥–ª—è NAT)
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    // –ö–∞–Ω–¥–∏–¥–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                }
            };
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            peerConnection.onconnectionstatechange = () => {
                console.log('–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', peerConnection.connectionState);
            };
        }
        
        // 5. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        async function copyOffer() {
            const offerText = document.getElementById('offerText');
            offerText.select();
            offerText.setSelectionRange(0, 99999);
            
            try {
                await navigator.clipboard.writeText(offerText.value);
                showStatus('‚úÖ –¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            } catch (err) {
                // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                document.execCommand('copy');
                showStatus('‚úÖ –¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
            }
        }
    </script>
</body>
</html>
