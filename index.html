<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoCatCall - Secure P2P Messenger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ====== –°–¢–ò–õ–ò –í–ù–£–¢–†–ò HTML ====== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --neon-green: #00ff9d;
            --neon-blue: #00d9ff;
            --dark-bg: #0a0a0f;
            --card-bg: #151520;
            --text-light: #ffffff;
            --text-muted: #8899aa;
            --success: #00ff9d;
            --error: #ff3366;
            --warning: #ffcc00;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--dark-bg);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(135deg, #0a0a0f 0%, #151525 100%);
        }

        .app-container {
            display: flex;
            height: 100vh;
            padding: 10px;
            gap: 10px;
        }

        /* –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ */
        .sidebar {
            width: 300px;
            background: rgba(20, 25, 40, 0.9);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border: 2px solid rgba(0, 255, 157, 0.3);
            box-shadow: 0 0 30px rgba(0, 255, 157, 0.2);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .logo i {
            font-size: 32px;
            color: var(--neon-green);
            text-shadow: 0 0 15px var(--neon-green);
        }

        .logo h1 {
            font-size: 24px;
            background: linear-gradient(90deg, var(--neon-green), var(--neon-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .connection-panel {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 217, 255, 0.3);
        }

        .server-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .server-input input {
            flex: 1;
            padding: 12px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--neon-blue);
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }

        .connect-btn {
            background: transparent;
            border: 2px solid var(--neon-green);
            color: var(--neon-green);
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .connect-btn:hover {
            background: var(--neon-green);
            color: black;
            box-shadow: 0 0 20px var(--neon-green);
        }

        .connect-btn.connected {
            background: var(--neon-green);
            color: black;
        }

        .my-id {
            background: rgba(0, 255, 157, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid var(--neon-green);
        }

        /* –ö–û–ù–¢–ê–ö–¢–´ */
        .contacts-section {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            flex: 1;
        }

        .section-title {
            color: var(--neon-blue);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .add-contact-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .add-contact-form input {
            flex: 1;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: white;
        }

        .small-btn {
            padding: 8px 15px;
            background: transparent;
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .small-btn:hover {
            background: var(--neon-blue);
            color: black;
        }

        .contacts-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .contact {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .contact:hover {
            background: rgba(0, 255, 157, 0.1);
            border-color: var(--neon-green);
        }

        .contact.active {
            background: rgba(0, 255, 157, 0.2);
            border-color: var(--neon-green);
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.3);
        }

        .contact-avatar {
            width: 40px;
            height: 40px;
            background: rgba(0, 255, 157, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 20px;
        }

        /* –ö–õ–Æ–ß –®–ò–§–†–û–í–ê–ù–ò–Ø */
        .key-section {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
        }

        .key-display {
            background: rgba(0, 0, 0, 0.5);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            font-size: 14px;
        }

        /* –û–°–ù–û–í–ù–û–ô –ß–ê–¢ */
        .main-chat {
            flex: 1;
            background: rgba(20, 25, 40, 0.9);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            border: 2px solid rgba(0, 217, 255, 0.3);
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.2);
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-partner-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            background: rgba(0, 255, 157, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .partner-status {
            font-size: 12px;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .partner-status::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
        }

        .call-buttons {
            display: flex;
            gap: 10px;
        }

        .call-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--neon-green);
            background: transparent;
            color: var(--neon-green);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .call-btn:hover {
            background: var(--neon-green);
            color: black;
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--neon-green);
        }

        /* –û–ë–õ–ê–°–¢–¨ –°–û–û–ë–©–ï–ù–ò–ô */
        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
        }

        .message {
            max-width: 70%;
            margin-bottom: 20px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.received {
            margin-right: auto;
        }

        .message.sent {
            margin-left: auto;
        }

        .message-content {
            background: rgba(0, 217, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(0, 217, 255, 0.3);
            position: relative;
        }

        .message.sent .message-content {
            background: rgba(0, 255, 157, 0.1);
            border-color: rgba(0, 255, 157, 0.3);
        }

        .message-time {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 5px;
            text-align: right;
        }

        .message-sender {
            font-size: 12px;
            color: var(--neon-blue);
            margin-bottom: 5px;
            font-weight: bold;
        }

        /* –í–í–û–î –°–û–û–ë–©–ï–ù–ò–ô */
        .input-area {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .key-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .key-input-row input {
            flex: 1;
            padding: 12px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--neon-green);
            border-radius: 8px;
            color: var(--neon-green);
            font-size: 16px;
        }

        .message-input-row {
            display: flex;
            gap: 10px;
        }

        .message-input-row input {
            flex: 1;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--neon-blue);
            border-radius: 8px;
            color: white;
            font-size: 16px;
        }

        .send-btn {
            background: var(--neon-blue);
            color: black;
            border: none;
            width: 60px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }

        .send-btn:hover {
            background: var(--neon-green);
            box-shadow: 0 0 20px var(--neon-blue);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* –ü–ê–ù–ï–õ–¨ –ó–í–û–ù–ö–û–í */
        .call-panel {
            width: 350px;
            background: rgba(20, 25, 40, 0.9);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border: 2px solid rgba(255, 51, 102, 0.3);
            box-shadow: 0 0 30px rgba(255, 51, 102, 0.2);
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 250px;
            background: black;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 2px solid var(--neon-green);
        }

        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #localVideo {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 100px;
            height: 75px;
            border: 2px solid var(--neon-blue);
            border-radius: 5px;
            background: black;
        }

        .call-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid var(--neon-blue);
            background: rgba(0, 217, 255, 0.1);
            color: var(--neon-blue);
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: var(--neon-blue);
            color: black;
            transform: scale(1.1);
        }

        .control-btn.end-call {
            border-color: var(--error);
            color: var(--error);
            background: rgba(255, 51, 102, 0.1);
        }

        .control-btn.end-call:hover {
            background: var(--error);
            color: white;
        }

        .call-info {
            text-align: center;
            color: var(--neon-green);
            font-size: 14px;
        }

        .call-timer {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            font-family: monospace;
        }

        /* –í–•–û–î–Ø–©–ò–ô –ó–í–û–ù–û–ö */
        .incoming-call {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            border: 2px solid var(--neon-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 10px var(--neon-green); }
            50% { box-shadow: 0 0 30px var(--neon-green); }
            100% { box-shadow: 0 0 10px var(--neon-green); }
        }

        .caller-avatar {
            width: 80px;
            height: 80px;
            background: rgba(0, 255, 157, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 20px;
            border: 3px solid var(--neon-green);
        }

        .key-input-call {
            margin: 20px 0;
        }

        .key-input-call input {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--neon-green);
            border-radius: 8px;
            color: var(--neon-green);
            font-size: 16px;
            text-align: center;
        }

        .call-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .accept-btn, .decline-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .accept-btn {
            background: var(--neon-green);
            color: black;
        }

        .accept-btn:hover {
            box-shadow: 0 0 20px var(--neon-green);
        }

        .decline-btn {
            background: var(--error);
            color: white;
        }

        .decline-btn:hover {
            box-shadow: 0 0 20px var(--error);
        }

        /* –£–¢–ò–õ–ò–¢–´ */
        .hidden {
            display: none !important;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            display: inline-block;
            margin-right: 5px;
            box-shadow: 0 0 10px var(--success);
        }

        .offline-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--error);
            display: inline-block;
            margin-right: 5px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success {
            background: rgba(0, 255, 157, 0.2);
            border: 1px solid var(--neon-green);
        }

        .notification.error {
            background: rgba(255, 51, 102, 0.2);
            border: 1px solid var(--error);
        }

        .notification.warning {
            background: rgba(255, 204, 0, 0.2);
            border: 1px solid var(--warning);
        }

        /* –ü–†–û–ö–†–£–¢–ö–ê */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--neon-green);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--neon-blue);
        }
    </style>
</head>
<body>
    <!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
    <div id="notifications"></div>

    <!-- –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° -->
    <div class="app-container">
        <!-- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ -->
        <div class="sidebar">
            <div class="logo">
                <i class="fas fa-cat"></i>
                <h1>CryptoCatCall</h1>
            </div>

            <!-- –ü–ê–ù–ï–õ–¨ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø -->
            <div class="connection-panel">
                <h3 class="section-title">
                    <i class="fas fa-plug"></i> –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                </h3>
                <div class="server-input">
                    <input type="text" id="serverUrl" 
                           value="ws://localhost:3000" 
                           placeholder="ws://localhost:3000">
                </div>
                <button id="connectBtn" class="connect-btn">
                    <i class="fas fa-plug"></i> –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
                </button>
                <div class="my-id">
                    <strong>–í–∞—à ID:</strong> 
                    <span id="myId">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</span>
                    <button onclick="copyMyId()" class="small-btn" style="margin-left: 10px;">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>

            <!-- –ö–û–ù–¢–ê–ö–¢–´ -->
            <div class="contacts-section">
                <h3 class="section-title">
                    <i class="fas fa-users"></i> –ö–æ–Ω—Ç–∞–∫—Ç—ã
                </h3>
                <div class="add-contact-form">
                    <input type="text" id="contactIdInput" 
                           placeholder="ID –¥—Ä—É–≥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: user_abc123)">
                    <button id="addContactBtn" class="small-btn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="contacts-list" id="contactsList">
                    <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>
            </div>

            <!-- –ö–õ–Æ–ß –®–ò–§–†–û–í–ê–ù–ò–Ø -->
            <div class="key-section">
                <h3 class="section-title">
                    <i class="fas fa-key"></i> –ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
                </h3>
                <div class="key-display" id="currentKeyDisplay">
                    –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                </div>
                <button id="setKeyBtn" class="small-btn" style="width: 100%;">
                    <i class="fas fa-edit"></i> –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–ª—é—á
                </button>
            </div>
        </div>

        <!-- –¶–ï–ù–¢–†–ê–õ–¨–ù–´–ô –ß–ê–¢ -->
        <div class="main-chat">
            <!-- –ó–ê–ì–û–õ–û–í–û–ö –ß–ê–¢–ê -->
            <div class="chat-header" id="chatHeader">
                <div id="noChatSelected">
                    <div class="chat-avatar">
                        <i class="fas fa-comment-dots"></i>
                    </div>
                    <div>
                        <h2>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è —á–∞—Ç–∞</h2>
                        <p>–°–æ–æ–±—â–µ–Ω–∏—è —à–∏—Ñ—Ä—É—é—Ç—Å—è end-to-end</p>
                    </div>
                </div>
                
                <div id="activeChatHeader" class="hidden">
                    <div class="chat-partner-info">
                        <div class="chat-avatar" id="partnerAvatar">
                            <i class="fas fa-user-secret"></i>
                        </div>
                        <div>
                            <h2 id="partnerName">-</h2>
                            <p class="partner-status">
                                <span class="online-dot"></span>
                                <span id="partnerStatus">online</span>
                            </p>
                        </div>
                    </div>
                    <div class="call-buttons">
                        <button class="call-btn" id="voiceCallBtn">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="call-btn" id="videoCallBtn">
                            <i class="fas fa-video"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- –°–û–û–ë–©–ï–ù–ò–Ø -->
            <div class="messages-container" id="messagesContainer">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                <div id="welcomeMessage">
                    <div style="text-align: center; padding: 50px;">
                        <div class="chat-avatar" style="width: 80px; height: 80px; margin: 0 auto 20px;">
                            <i class="fas fa-lock"></i>
                        </div>
                        <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ CryptoCatCall!</h2>
                        <p>–í–∞—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞—â–∏—â–µ–Ω—ã end-to-end —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º</p>
                        <p>1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É</p>
                        <p>2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è</p>
                        <p>3. –î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –ø–æ ID</p>
                        <p>4. –ù–∞—á–Ω–∏—Ç–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ</p>
                    </div>
                </div>
            </div>

            <!-- –í–í–û–î –°–û–û–ë–©–ï–ù–ò–ô -->
            <div class="input-area">
                <div class="key-input-row">
                    <input type="password" id="encryptionKeyInput" 
                           placeholder="üîê –í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: CAT123)">
                    <button id="setKeyQuickBtn" class="connect-btn">
                        <i class="fas fa-check"></i> –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
                <div class="message-input-row">
                    <input type="text" id="messageInput" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–±—É–¥–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ)" 
                           disabled>
                    <button id="sendBtn" class="send-btn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ - –ó–í–û–ù–ö–ò -->
        <div class="call-panel">
            <!-- –í–•–û–î–Ø–©–ò–ô –ó–í–û–ù–û–ö -->
            <div id="incomingCallContainer" class="hidden">
                <div class="incoming-call">
                    <div class="caller-avatar">
                        <i class="fas fa-phone-volume"></i>
                    </div>
                    <h3>–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</h3>
                    <p>–û—Ç: <strong id="callerId">-</strong></p>
                    <div class="key-input-call">
                        <input type="password" id="callKeyInput" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á –¥–ª—è –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏">
                    </div>
                    <div class="call-actions">
                        <button id="answerCallBtn" class="accept-btn">
                            <i class="fas fa-phone"></i> –ü—Ä–∏–Ω—è—Ç—å
                        </button>
                        <button id="declineCallBtn" class="decline-btn">
                            <i class="fas fa-phone-slash"></i> –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>

            <!-- –ê–ö–¢–ò–í–ù–´–ô –ó–í–û–ù–û–ö -->
            <div id="activeCallContainer" class="hidden">
                <div class="video-container">
                    <video id="remoteVideo" autoplay playsinline></video>
                    <video id="localVideo" autoplay muted playsinline></video>
                </div>
                
                <div class="call-controls">
                    <button class="control-btn" id="toggleAudioBtn">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="control-btn" id="toggleVideoBtn">
                        <i class="fas fa-video"></i>
                    </button>
                    <button class="control-btn end-call" id="endCallBtn">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
                
                <div class="call-info">
                    <div class="call-timer" id="callTimer">00:00</div>
                    <p><i class="fas fa-lock"></i> –ó–≤–æ–Ω–æ–∫ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω end-to-end</p>
                </div>
            </div>

            <!-- –°–¢–ê–¢–£–° –ó–í–û–ù–ö–û–í -->
            <div id="callStatus" style="text-align: center; padding: 30px;">
                <div class="chat-avatar" style="width: 60px; height: 60px; margin: 0 auto 15px;">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h3>–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∑–≤–æ–Ω–∫–∏</h3>
                <p>–ó–≤–æ–Ω–∫–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</p>
                <p>–ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã</p>
                <p>–ö–ª—é—á –Ω—É–∂–µ–Ω –¥–ª—è –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏</p>
            </div>

            <!-- –î–ï–ë–ê–ì –ò–ù–§–û -->
            <div style="margin-top: auto; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
                <h4 style="color: var(--neon-blue); margin-bottom: 10px;">
                    <i class="fas fa-code"></i> –°—Ç–∞—Ç—É—Å:
                </h4>
                <div style="font-size: 12px; font-family: monospace;">
                    <p>–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: <span id="debugConn">‚ùå –û—Ç–∫–ª—é—á–µ–Ω</span></p>
                    <p>–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ: <span id="debugEnc">‚ùå –ù–µ –∞–∫—Ç–∏–≤–Ω–æ</span></p>
                    <p>–ó–≤–æ–Ω–æ–∫: <span id="debugCall">üìû –ù–µ –∞–∫—Ç–∏–≤–µ–Ω</span></p>
                    <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω: <span id="onlineCount">0</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –ö–õ–Æ–ß–ê -->
    <div id="keyModal" class="hidden" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    ">
        <div style="
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid var(--neon-green);
            width: 400px;
            max-width: 90%;
        ">
            <h2 style="color: var(--neon-green); margin-bottom: 15px;">
                <i class="fas fa-key"></i> –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
            </h2>
            <p style="margin-bottom: 20px; color: var(--text-muted);">
                –≠—Ç–æ—Ç –∫–ª—é—á –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∑–≤–æ–Ω–∫–æ–≤.
                <br><br>
                <strong>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º –∫–ª—é—á–æ–º —Å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º!</strong>
            </p>
            <input type="password" id="newKeyInput" 
                   placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á (–º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞)"
                   style="
                       width: 100%;
                       padding: 15px;
                       background: rgba(0,0,0,0.5);
                       border: 2px solid var(--neon-green);
                       border-radius: 8px;
                       color: var(--neon-green);
                       font-size: 16px;
                       margin-bottom: 20px;
                   ">
            <div style="display: flex; gap: 10px;">
                <button id="cancelKeyBtn" style="
                    flex: 1;
                    padding: 15px;
                    background: transparent;
                    border: 2px solid var(--error);
                    color: var(--error);
                    border-radius: 8px;
                    cursor: pointer;
                ">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button id="confirmKeyBtn" style="
                    flex: 1;
                    padding: 15px;
                    background: var(--neon-green);
                    border: none;
                    color: black;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: bold;
                ">
                    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–ª—é—á
                </button>
            </div>
        </div>
    </div>

    <!-- –í–°–ï –°–ö–†–ò–ü–¢–´ –í–ù–£–¢–†–ò HTML -->
    <script>
        // ====== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ======
        const CONFIG = {
            DEFAULT_SERVER: 'ws://localhost:3000',
            MIN_KEY_LENGTH: 4
        };

        // ====== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ======
        let socket = null;
        let peer = null;
        let encryptionKey = null;
        let currentContact = null;
        let contacts = {};
        let localStream = null;
        let callStartTime = null;
        let callTimerInterval = null;
        let userId = null;
        let isConnected = false;

        // ====== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ======
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        function initApp() {
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            userId = 'user_' + Math.random().toString(36).substr(2, 9);
            document.getElementById('myId').textContent = userId;
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            setupEventListeners();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            loadSavedData();
        }

        function setupEventListeners() {
            // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
            document.getElementById('connectBtn').addEventListener('click', connectToServer);
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞
            document.getElementById('addContactBtn').addEventListener('click', addContact);
            document.getElementById('contactIdInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addContact();
            });
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–æ–º
            document.getElementById('setKeyBtn').addEventListener('click', showKeyModal);
            document.getElementById('setKeyQuickBtn').addEventListener('click', () => {
                const key = document.getElementById('encryptionKeyInput').value;
                if (key.length >= CONFIG.MIN_KEY_LENGTH) {
                    setEncryptionKey(key);
                    document.getElementById('encryptionKeyInput').value = '';
                } else {
                    showNotification('–ö–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞', 'error');
                }
            });
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // –ó–≤–æ–Ω–∫–∏
            document.getElementById('voiceCallBtn').addEventListener('click', () => initiateCall('audio'));
            document.getElementById('videoCallBtn').addEventListener('click', () => initiateCall('video'));
            document.getElementById('answerCallBtn').addEventListener('click', answerCall);
            document.getElementById('declineCallBtn').addEventListener('click', declineCall);
            document.getElementById('endCallBtn').addEventListener('click', endCall);
            document.getElementById('toggleAudioBtn').addEventListener('click', toggleAudio);
            document.getElementById('toggleVideoBtn').addEventListener('click', toggleVideo);
            
            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–ª—é—á–∞
            document.getElementById('cancelKeyBtn').addEventListener('click', () => {
                document.getElementById('keyModal').classList.add('hidden');
            });
            document.getElementById('confirmKeyBtn').addEventListener('click', () => {
                const key = document.getElementById('newKeyInput').value;
                if (key.length >= CONFIG.MIN_KEY_LENGTH) {
                    setEncryptionKey(key);
                    document.getElementById('keyModal').classList.add('hidden');
                    document.getElementById('newKeyInput').value = '';
                } else {
                    showNotification('–ö–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞', 'error');
                }
            });
            
            // –ó–∞–ø—É—Å–∫ –ø–æ Enter –≤ –ø–æ–ª–µ –∫–ª—é—á–∞
            document.getElementById('encryptionKeyInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('setKeyQuickBtn').click();
                }
            });
        }

        // ====== –°–û–ï–î–ò–ù–ï–ù–ò–ï –° –°–ï–†–í–ï–†–û–ú ======
        function connectToServer() {
            if (isConnected && socket) {
                disconnectFromServer();
                return;
            }
            
            const serverUrl = document.getElementById('serverUrl').value || CONFIG.DEFAULT_SERVER;
            
            try {
                socket = io(serverUrl, {
                    transports: ['websocket'],
                    reconnection: true,
                    reconnectionAttempts: 5
                });
                
                setupSocketListeners();
                
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message, 'error');
                updateDebugInfo('conn', '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        }

        function setupSocketListeners() {
            socket.on('connect', () => {
                isConnected = true;
                showNotification('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É', 'success');
                updateDebugInfo('conn', '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—à ID
                socket.emit('register', {
                    userId: userId,
                    username: 'User_' + userId.substr(5, 4)
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                document.getElementById('connectBtn').innerHTML = '<i class="fas fa-plug"></i> –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è';
                document.getElementById('connectBtn').classList.add('connected');
                document.getElementById('myId').textContent = userId;
            });
            
            socket.on('disconnect', () => {
                isConnected = false;
                showNotification('‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞', 'error');
                updateDebugInfo('conn', '‚ùå –û—Ç–∫–ª—é—á–µ–Ω');
                
                document.getElementById('connectBtn').innerHTML = '<i class="fas fa-plug"></i> –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è';
                document.getElementById('connectBtn').classList.remove('connected');
            });
            
            socket.on('users-online', (count) => {
                document.getElementById('onlineCount').textContent = count;
            });
            
            socket.on('message', (data) => {
                handleIncomingMessage(data);
            });
            
            socket.on('incoming-call', (data) => {
                showIncomingCall(data);
            });
            
            socket.on('call-accepted', (data) => {
                startCall(data);
            });
            
            socket.on('call-ended', () => {
                endCall();
            });
            
            socket.on('error', (error) => {
                showNotification('–û—à–∏–±–∫–∞: ' + error, 'error');
            });
        }

        function disconnectFromServer() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            isConnected = false;
            showNotification('–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞', 'warning');
            updateDebugInfo('conn', '‚ùå –û—Ç–∫–ª—é—á–µ–Ω');
        }

        // ====== –®–ò–§–†–û–í–ê–ù–ò–ï ======
        function encryptText(text) {
            if (!encryptionKey) throw new Error('–ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            
            // –ü—Ä–æ—Å—Ç–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Web Crypto API
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i) ^ encryptionKey.charCodeAt(i % encryptionKey.length);
                result += String.fromCharCode(charCode);
            }
            return btoa(result); // –ö–æ–¥–∏—Ä—É–µ–º –≤ base64
        }

        function decryptText(encryptedText) {
            if (!encryptionKey) throw new Error('–ö–ª—é—á –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            
            try {
                const decoded = atob(encryptedText);
                let result = '';
                for (let i = 0; i < decoded.length; i++) {
                    const charCode = decoded.charCodeAt(i) ^ encryptionKey.charCodeAt(i % encryptionKey.length);
                    result += String.fromCharCode(charCode);
                }
                return result;
            } catch (error) {
                throw new Error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏: –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á');
            }
        }

        function setEncryptionKey(key) {
            encryptionKey = key;
            document.getElementById('currentKeyDisplay').textContent = key;
            updateDebugInfo('enc', '‚úÖ –ê–∫—Ç–∏–≤–Ω–æ');
            showNotification('‚úÖ –ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'success');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á
            localStorage.setItem('cryptocat_key', key);
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π
            if (currentContact) {
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
            }
        }

        // ====== –ö–û–ù–¢–ê–ö–¢–´ ======
        function addContact() {
            const contactId = document.getElementById('contactIdInput').value.trim();
            if (!contactId) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–Ω—Ç–∞–∫—Ç–∞', 'error');
                return;
            }
            
            if (contactId === userId) {
                showNotification('–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è', 'error');
                return;
            }
            
            if (contacts[contactId]) {
                showNotification('–ö–æ–Ω—Ç–∞–∫—Ç —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω', 'warning');
                return;
            }
            
            contacts[contactId] = {
                id: contactId,
                name: 'Contact_' + contactId.substr(5, 4),
                online: false,
                messages: []
            };
            
            updateContactsList();
            document.getElementById('contactIdInput').value = '';
            saveContacts();
            showNotification('–ö–æ–Ω—Ç–∞–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
        }

        function selectContact(contactId) {
            if (!contacts[contactId]) return;
            
            currentContact = contactId;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('noChatSelected').classList.add('hidden');
            document.getElementById('activeChatHeader').classList.remove('hidden');
            document.getElementById('partnerName').textContent = contacts[contactId].name;
            document.getElementById('partnerStatus').textContent = contacts[contactId].online ? 'online' : 'offline';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
            updateContactsList();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
            loadMessages(contactId);
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π –µ—Å–ª–∏ –µ—Å—Ç—å –∫–ª—é—á
            if (encryptionKey) {
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
            }
        }

        function updateContactsList() {
            const container = document.getElementById('contactsList');
            container.innerHTML = '';
            
            Object.values(contacts).forEach(contact => {
                const div = document.createElement('div');
                div.className = `contact ${currentContact === contact.id ? 'active' : ''}`;
                div.onclick = () => selectContact(contact.id);
                
                div.innerHTML = `
                    <div class="contact-avatar">
                        ${contact.online ? '‚úÖ' : '‚≠ï'}
                    </div>
                    <div style="flex: 1;">
                        <strong>${contact.name}</strong>
                        <div style="font-size: 12px; color: ${contact.online ? '#00ff9d' : '#8899aa'}">
                            ${contact.online ? '–í —Å–µ—Ç–∏' : '–ù–µ –≤ —Å–µ—Ç–∏'}
                        </div>
                    </div>
                    ${contact.unread ? `<span style="background: #ff3366; color: white; padding: 2px 6px; border-radius: 10px; font-size: 12px;">${contact.unread}</span>` : ''}
                `;
                
                container.appendChild(div);
            });
        }

        // ====== –°–û–û–ë–©–ï–ù–ò–Ø ======
        function sendMessage() {
            if (!currentContact || !encryptionKey || !isConnected) {
                showNotification('–ù–µ –º–æ–≥—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', 'error');
                return;
            }
            
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            try {
                // –®–∏—Ñ—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                const encrypted = encryptText(text);
                
                // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                const message = {
                    id: Date.now(),
                    from: userId,
                    to: currentContact,
                    text: encrypted,
                    timestamp: new Date().toISOString(),
                    type: 'text'
                };
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
                socket.emit('message', message);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
                if (!contacts[currentContact].messages) {
                    contacts[currentContact].messages = [];
                }
                contacts[currentContact].messages.push({
                    ...message,
                    text: text,
                    sent: true
                });
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                displayMessage(text, true);
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                input.value = '';
                input.focus();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
                saveContacts();
                
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è: ' + error.message, 'error');
            }
        }

        function handleIncomingMessage(data) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–æ–π –∫–æ–Ω—Ç–∞–∫—Ç
            if (!contacts[data.from]) {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –≤ –∫–æ–Ω—Ç–∞–∫—Ç—ã
                contacts[data.from] = {
                    id: data.from,
                    name: 'Contact_' + data.from.substr(5, 4),
                    online: true,
                    messages: []
                };
                updateContactsList();
            }
            
            try {
                // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å
                const decrypted = decryptText(data.text);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (!contacts[data.from].messages) {
                    contacts[data.from].messages = [];
                }
                contacts[data.from].messages.push({
                    ...data,
                    text: decrypted,
                    sent: false
                });
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –µ—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç
                if (currentContact === data.from) {
                    displayMessage(decrypted, false);
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    contacts[data.from].unread = (contacts[data.from].unread || 0) + 1;
                    updateContactsList();
                    showNotification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${contacts[data.from].name}`, 'success');
                }
                
                saveContacts();
                
            } catch (error) {
                // –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (currentContact === data.from) {
                    displayMessage('üîí [–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –Ω—É–∂–µ–Ω –∫–ª—é—á]', false);
                }
            }
        }

        function displayMessage(text, isSent, senderName = null) {
            const container = document.getElementById('messagesContainer');
            
            // –ü—Ä—è—á–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            const welcome = document.getElementById('welcomeMessage');
            if (welcome) welcome.style.display = 'none';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            
            const time = new Date().toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    ${senderName ? `<div class="message-sender">${senderName}</div>` : ''}
                    <div>${text}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function loadMessages(contactId) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            if (!contacts[contactId] || !contacts[contactId].messages) {
                return;
            }
            
            contacts[contactId].messages.forEach(msg => {
                displayMessage(msg.text, msg.sent || msg.from === userId);
            });
        }

        // ====== –ó–í–û–ù–ö–ò ======
        async function initiateCall(type) {
            if (!currentContact || !encryptionKey || !isConnected) {
                showNotification('–ù–µ –º–æ–≥—É –Ω–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫', 'error');
                return;
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: type === 'video'
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                document.getElementById('localVideo').srcObject = localStream;
                
                // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫
                document.getElementById('callStatus').classList.add('hidden');
                document.getElementById('activeCallContainer').classList.remove('hidden');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∑–≤–æ–Ω–æ–∫
                socket.emit('call-request', {
                    from: userId,
                    to: currentContact,
                    type: type,
                    key: encryptionKey
                });
                
                startCallTimer();
                updateDebugInfo('call', `üìû –ò—Å—Ö–æ–¥—è—â–∏–π ${type}`);
                
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + error.message, 'error');
            }
        }

        function showIncomingCall(data) {
            document.getElementById('callerId').textContent = data.from;
            document.getElementById('callStatus').classList.add('hidden');
            document.getElementById('incomingCallContainer').classList.remove('hidden');
            updateDebugInfo('call', 'üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫');
        }

        async function answerCall() {
            const callKey = document.getElementById('callKeyInput').value;
            
            if (!callKey) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –∑–≤–æ–Ω–∫–∞', 'error');
                return;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª—é—á –µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
            if (!encryptionKey) {
                setEncryptionKey(callKey);
            } else if (encryptionKey !== callKey) {
                showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏', 'error');
                return;
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: true // –î–ª—è –≤–∏–¥–µ–æ –∑–≤–æ–Ω–∫–∞
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Ö–æ–¥—è—â–∏–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫
                document.getElementById('incomingCallContainer').classList.add('hidden');
                document.getElementById('activeCallContainer').classList.remove('hidden');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                socket.emit('call-accept', {
                    from: userId,
                    to: document.getElementById('callerId').textContent
                });
                
                startCallTimer();
                updateDebugInfo('call', 'üìû –ê–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫');
                
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ –Ω–∞ –∑–≤–æ–Ω–æ–∫', 'error');
            }
        }

        function declineCall() {
            socket.emit('call-decline', document.getElementById('callerId').textContent);
            document.getElementById('incomingCallContainer').classList.add('hidden');
            document.getElementById('callStatus').classList.remove('hidden');
            updateDebugInfo('call', 'üìû –ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
        }

        function startCall(data) {
            // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è WebRTC —á–µ—Ä–µ–∑ SimplePeer
            // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
            startCallTimer();
            updateDebugInfo('call', 'üìû –ó–≤–æ–Ω–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            
            showNotification('–ó–≤–æ–Ω–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ì–æ–≤–æ—Ä–∏—Ç–µ!', 'success');
        }

        function endCall() {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
            if (callTimerInterval) {
                clearInterval(callTimerInterval);
                callTimerInterval = null;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–∏–¥–µ–æ
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º UI –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            document.getElementById('incomingCallContainer').classList.add('hidden');
            document.getElementById('activeCallContainer').classList.add('hidden');
            document.getElementById('callStatus').classList.remove('hidden');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞
            if (socket) {
                socket.emit('call-end');
            }
            
            updateDebugInfo('call', 'üìû –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
            showNotification('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'warning');
        }

        function toggleAudio() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    const btn = document.getElementById('toggleAudioBtn');
                    btn.innerHTML = audioTrack.enabled ? 
                        '<i class="fas fa-microphone"></i>' : 
                        '<i class="fas fa-microphone-slash"></i>';
                }
            }
        }

        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    const btn = document.getElementById('toggleVideoBtn');
                    btn.innerHTML = videoTrack.enabled ? 
                        '<i class="fas fa-video"></i>' : 
                        '<i class="fas fa-video-slash"></i>';
                }
            }
        }

        function startCallTimer() {
            callStartTime = new Date();
            callTimerInterval = setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - callStartTime) / 1000);
                const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
                const seconds = (diff % 60).toString().padStart(2, '0');
                document.getElementById('callTimer').textContent = `${minutes}:${seconds}`;
            }, 1000);
        }

        // ====== –£–¢–ò–õ–ò–¢–´ ======
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
            `;
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function updateDebugInfo(type, value) {
            document.getElementById('debug' + type.charAt(0).toUpperCase() + type.slice(1)).textContent = value;
        }

        function copyMyId() {
            navigator.clipboard.writeText(userId)
                .then(() => showNotification('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä', 'success'))
                .catch(() => showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID', 'error'));
        }

        function showKeyModal() {
            document.getElementById('keyModal').classList.remove('hidden');
            document.getElementById('newKeyInput').focus();
        }

        // ====== –°–û–•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• ======
        function saveContacts() {
            localStorage.setItem('cryptocat_contacts', JSON.stringify(contacts));
        }

        function loadSavedData() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª—é—á
            const savedKey = localStorage.getItem('cryptocat_key');
            if (savedKey) {
                setEncryptionKey(savedKey);
                document.getElementById('encryptionKeyInput').value = savedKey;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã
            const savedContacts = localStorage.getItem('cryptocat_contacts');
            if (savedContacts) {
                try {
                    contacts = JSON.parse(savedContacts);
                    updateContactsList();
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:', e);
                }
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ—Ä–≤–µ—Ä
            const savedServer = localStorage.getItem('cryptocat_server');
            if (savedServer) {
                document.getElementById('serverUrl').value = savedServer;
            }
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        document.getElementById('serverUrl').addEventListener('change', (e) => {
            localStorage.setItem('cryptocat_server', e.target.value);
        });

        // ====== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ======
        window.copyMyId = copyMyId;
    </script>
</body>
</html>
