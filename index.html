<!DOCTYPE html>
<html>
<head>
    <title>–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ –±–µ–∑ QR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
        }
        
        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .videos-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .video-box {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .video-box h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        video {
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 10px;
            object-fit: cover;
        }
        
        .controls {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .step {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }
        
        .step h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 200px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #3ca56d;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }
        
        .btn-secondary {
            background: #a0aec0;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #90a0b3;
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
            display: none;
        }
        
        .status-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .status-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        
        .status-info {
            background: #bee3f8;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }
        
        .data-exchange {
            background: #2d3748;
            color: white;
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
        }
        
        .data-exchange h4 {
            margin-bottom: 15px;
            color: #a0aec0;
        }
        
        .data-box {
            background: #1a202c;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        textarea {
            width: 100%;
            min-height: 100px;
            background: #2d3748;
            color: white;
            border: 2px solid #4a5568;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
        }
        
        .copy-hint {
            color: #a0aec0;
            font-size: 0.9rem;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .log {
            background: #1a202c;
            color: #68d391;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #2d3748;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            color: white;
            margin-bottom: 20px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e53e3e;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #48bb78;
            animation: none;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .videos-container {
                flex-direction: column;
            }
            
            .btn {
                min-width: 100%;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé• –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ —Å –¥—Ä—É–≥–æ–º</h1>
            <p>–ü—Ä–æ—Å—Ç–æ –Ω–∞–∂–∏–º–∞–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! –∏ —Å–æ–∑–¥–∞–Ω–æ –í–∞–ª–µ—Ä–æ–π (cryptoCat)</p>
        </div>
        
        <div class="connection-status">
            <div class="status-dot" id="statusDot"></div>
            <span id="connectionStatusText">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
        </div>
        
        <div class="videos-container">
            <div class="video-box">
                <h3>üë§ –í–∞—à–∞ –∫–∞–º–µ—Ä–∞</h3>
                <video id="localVideo" autoplay muted playsinline></video>
                <div id="localStatus"></div>
            </div>
            <div class="video-box">
                <h3>üë• –î—Ä—É–≥</h3>
                <video id="remoteVideo" autoplay playsinline></video>
                <div id="remoteStatus"></div>
            </div>
        </div>
        
        <div class="controls">
            <div class="step">
                <h3><span class="step-number">1</span> –í–∫–ª—é—á–∏—Ç–µ –∫–∞–º–µ—Ä—É</h3>
                <p>–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ, –∫–æ–≥–¥–∞ –±—Ä–∞—É–∑–µ—Ä –∑–∞–ø—Ä–æ—Å–∏—Ç</p>
                <div class="buttons">
                    <button class="btn btn-primary" onclick="startCamera()">
                        üì∑ –í–∫–ª—é—á–∏—Ç—å –º–æ—é –∫–∞–º–µ—Ä—É
                    </button>
                </div>
                <div id="cameraStatus" class="status"></div>
            </div>
            
            <div class="step">
                <h3><span class="step-number">2</span> –ù–∞—á–Ω–∏—Ç–µ –∏–ª–∏ –ø—Ä–∏–º–∏—Ç–µ –∑–≤–æ–Ω–æ–∫</h3>
                <p>–ï—Å–ª–∏ –≤—ã –∑–≤–æ–Ω–∏—Ç–µ –ø–µ—Ä–≤—ã–º - –Ω–∞–∂–º–∏—Ç–µ "–Ø –∑–≤–æ–Ω—é". –ï—Å–ª–∏ –≤–∞–º –∑–≤–æ–Ω—è—Ç - "–ú–Ω–µ –∑–≤–æ–Ω—è—Ç"</p>
                <div class="buttons">
                    <button class="btn btn-success" id="callBtn" onclick="startCall()" disabled>
                        üìû –Ø –∑–≤–æ–Ω—é (–Ω–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫)
                    </button>
                    <button class="btn btn-primary" id="answerBtn" onclick="receiveCall()" disabled>
                        üì≤ –ú–Ω–µ –∑–≤–æ–Ω—è—Ç (–ø—Ä–∏–Ω—è—Ç—å –∑–≤–æ–Ω–æ–∫)
                    </button>
                </div>
                <div id="callStatus" class="status"></div>
            </div>
            
            <div class="step">
                <h3><span class="step-number">3</span> –û–±–º–µ–Ω—è–π—Ç–µ—Å—å –∫–æ–¥–∞–º–∏</h3>
                <p>–ö–æ–¥—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞. –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏—Ö –¥—Ä—É–≥—É –ª—é–±—ã–º —Å–ø–æ—Å–æ–±–æ–º</p>
                
                <div class="data-exchange">
                    <h4>üìã –ö–æ–¥ –¥–ª—è –¥—Ä—É–≥–∞:</h4>
                    <div class="data-box">
                        <p id="dataHint">–ù–∞–∂–º–∏—Ç–µ "–Ø –∑–≤–æ–Ω—é", —á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</p>
                        <textarea id="offerData" readonly></textarea>
                        <div class="copy-hint" id="copyHint"></div>
                    </div>
                    
                    <div class="buttons">
                        <button class="btn btn-secondary" id="copyBtn" onclick="copyOffer()" disabled>
                            üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
                        </button>
                        <button class="btn btn-success" id="pasteBtn" onclick="pasteAnswer()" disabled>
                            ‚úÖ –í—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="log">
            <div id="connectionLog">
                <div class="log-entry">[–°–∏—Å—Ç–µ–º–∞] –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
                <div class="log-entry">[–°–∏—Å—Ç–µ–º–∞] –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏</div>
            </div>
        </div>
    </div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let localStream = null;
let peerConnection = null;
let isCaller = false;

// –≠–ª–µ–º–µ–Ω—Ç—ã DOM
const logArea = document.getElementById('connectionLog');
const statusDot = document.getElementById('statusDot');
const statusText = document.getElementById('connectionStatusText');
const cameraStatusEl = document.getElementById('cameraStatus');
const callStatusEl = document.getElementById('callStatus');
const copyHint = document.getElementById('copyHint');
const dataHint = document.getElementById('dataHint');

// –ö–Ω–æ–ø–∫–∏
const callBtn = document.getElementById('callBtn');
const answerBtn = document.getElementById('answerBtn');
const copyBtn = document.getElementById('copyBtn');
const pasteBtn = document.getElementById('pasteBtn');

// –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
function addLog(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const colors = {
        'info': '#68d391',
        'success': '#48bb78',
        'error': '#fc8181',
        'warning': '#f6ad55',
        'system': '#a0aec0'
    };
    
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    logEntry.innerHTML = `<span style="color: ${colors[type] || colors.info}">[${timestamp}] ${message}</span>`;
    logArea.appendChild(logEntry);
    logArea.scrollTop = logArea.scrollHeight;
    
    console.log(`[${type.toUpperCase()}] ${message}`);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
function updateConnectionStatus(isConnected, message) {
    statusDot.className = `status-dot ${isConnected ? 'connected' : ''}`;
    statusText.textContent = message;
    
    if (isConnected) {
        addLog(`‚úÖ ${message}`, 'success');
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showStatus(element, message, type = 'info') {
    element.textContent = message;
    element.className = `status status-${type}`;
    element.style.display = 'block';
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    if (type !== 'error') {
        setTimeout(() => {
            element.style.display = 'none';
        }, 5000);
    }
}

// 1. –í–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
async function startCamera() {
    try {
        showStatus(cameraStatusEl, '–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...', 'info');
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
        localStream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                frameRate: { ideal: 30 }
            },
            audio: false
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
        document.getElementById('localVideo').srcObject = localStream;
        
        // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
        callBtn.disabled = false;
        answerBtn.disabled = false;
        
        showStatus(cameraStatusEl, '‚úÖ –ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!', 'success');
        addLog('–ö–∞–º–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞', 'success');
        updateConnectionStatus(false, '–ö–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞');
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–≤—É–∫–æ–≤–æ–π —ç—Ñ—Ñ–µ–∫—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        playSound('success');
        
    } catch (error) {
        showStatus(cameraStatusEl, `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        addLog(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ: ${error.message}`, 'error');
    }
}

// 2. –°–æ–∑–¥–∞–Ω–∏–µ WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
function createPeerConnection() {
    try {
        // –ù–∞–¥–µ–∂–Ω—ã–µ STUN —Å–µ—Ä–≤–µ—Ä—ã
        const iceServers = [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            { urls: 'stun:stun3.l.google.com:19302' },
            { urls: 'stun:stun4.l.google.com:19302' },
            { urls: 'stun:stun.services.mozilla.com' }
        ];
        
        addLog('–°–æ–∑–¥–∞—é WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...', 'info');
        
        peerConnection = new RTCPeerConnection({ iceServers });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
        if (localStream) {
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            addLog('–õ–æ–∫–∞–ª—å–Ω—ã–π –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫
        peerConnection.ontrack = (event) => {
            if (event.streams && event.streams[0]) {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
                addLog('‚úÖ –ü–æ–ª—É—á–µ–Ω –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –æ—Ç –¥—Ä—É–≥–∞!', 'success');
                updateConnectionStatus(true, '–í–∏–¥–µ–æ—Å–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
                playSound('connection');
            }
        };
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                addLog('–û–±–Ω–∞—Ä—É–∂–µ–Ω ICE –∫–∞–Ω–¥–∏–¥–∞—Ç', 'info');
            } else {
                addLog('‚úÖ –í—Å–µ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã —Å–æ–±—Ä–∞–Ω—ã', 'success');
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–ø–∏—Ä—É–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –µ—Å–ª–∏ –º—ã –∑–≤–æ–Ω–∏–º
                if (isCaller && peerConnection.localDescription) {
                    setTimeout(() => {
                        copyOffer();
                    }, 1000);
                }
            }
        };
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        peerConnection.oniceconnectionstatechange = () => {
            const state = peerConnection.iceConnectionState;
            addLog(`–°–æ—Å—Ç–æ—è–Ω–∏–µ ICE: ${state}`, 'info');
            
            if (state === 'connected' || state === 'completed') {
                updateConnectionStatus(true, '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            } else if (state === 'failed') {
                updateConnectionStatus(false, '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                addLog('–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞', 'error');
            }
        };
        
        addLog('WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ', 'success');
        
    } catch (error) {
        addLog(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
    }
}

// 3. –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫
async function startCall() {
    if (!localStream) {
        showStatus(callStatusEl, '–°–Ω–∞—á–∞–ª–∞ –≤–∫–ª—é—á–∏—Ç–µ –∫–∞–º–µ—Ä—É!', 'error');
        return;
    }
    
    addLog('=== –í—ã –Ω–∞—á–∏–Ω–∞–µ—Ç–µ –∑–≤–æ–Ω–æ–∫ ===', 'info');
    isCaller = true;
    
    createPeerConnection();
    
    try {
        // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
        const offer = await peerConnection.createOffer({
            offerToReceiveVideo: true,
            offerToReceiveAudio: false
        });
        
        await peerConnection.setLocalDescription(offer);
        addLog('‚úÖ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∑–≤–æ–Ω–∫–∞ —Å–æ–∑–¥–∞–Ω–æ', 'success');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –ø–æ–ª–µ
        const offerString = JSON.stringify(peerConnection.localDescription);
        document.getElementById('offerData').value = offerString;
        dataHint.textContent = '–ö–æ–¥ –¥–ª—è –∑–≤–æ–Ω–∫–∞ –≥–æ—Ç–æ–≤! –û–Ω —É–∂–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.';
        
        // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
        copyBtn.disabled = false;
        pasteBtn.disabled = false;
        
        showStatus(callStatusEl, '‚úÖ –ö–æ–¥ –∑–≤–æ–Ω–∫–∞ –≥–æ—Ç–æ–≤! –û–Ω —É–∂–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –¥—Ä—É–≥—É.', 'success');
        updateConnectionStatus(false, '–ñ–¥—É –æ—Ç–≤–µ—Ç–∞ –æ—Ç –¥—Ä—É–≥–∞...');
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ 500–º—Å
        setTimeout(copyOffer, 500);
        
    } catch (error) {
        showStatus(callStatusEl, `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        addLog(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: ${error.message}`, 'error');
    }
}

// 4. –ü—Ä–∏–Ω—è—Ç—å –∑–≤–æ–Ω–æ–∫
async function receiveCall() {
    if (!localStream) {
        showStatus(callStatusEl, '–°–Ω–∞—á–∞–ª–∞ –≤–∫–ª—é—á–∏—Ç–µ –∫–∞–º–µ—Ä—É!', 'error');
        return;
    }
    
    addLog('=== –í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –∑–≤–æ–Ω–æ–∫ ===', 'info');
    isCaller = false;
    
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–¥ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const offerString = prompt('üìã –í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤–∞–º –æ—Ç–ø—Ä–∞–≤–∏–ª –¥—Ä—É–≥:');
    if (!offerString) {
        addLog('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –≤–≤–æ–¥', 'warning');
        return;
    }
    
    try {
        createPeerConnection();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç –¥—Ä—É–≥–∞
        const offer = JSON.parse(offerString);
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        addLog('‚úÖ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥—Ä—É–≥–∞ –ø—Ä–∏–Ω—è—Ç–æ', 'success');
        
        // –°–æ–∑–¥–∞–µ–º –æ—Ç–≤–µ—Ç
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        addLog('‚úÖ –û—Ç–≤–µ—Ç —Å–æ–∑–¥–∞–Ω', 'success');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
        const answerString = JSON.stringify(peerConnection.localDescription);
        document.getElementById('offerData').value = answerString;
        dataHint.textContent = '–û—Ç–≤–µ—Ç –≥–æ—Ç–æ–≤! –û–Ω —É–∂–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ –¥—Ä—É–≥—É.';
        
        // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
        copyBtn.disabled = false;
        pasteBtn.disabled = false;
        
        showStatus(callStatusEl, '‚úÖ –û—Ç–≤–µ—Ç —Å–æ–∑–¥–∞–Ω! –û–Ω —É–∂–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –¥—Ä—É–≥—É.', 'success');
        updateConnectionStatus(false, '–ñ–¥—É —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...');
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
        setTimeout(copyOffer, 500);
        
    } catch (error) {
        showStatus(callStatusEl, `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        addLog(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–≤–æ–Ω–∫–∞: ${error.message}`, 'error');
    }
}

// 5. –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ/–æ—Ç–≤–µ—Ç
async function copyOffer() {
    const textarea = document.getElementById('offerData');
    const text = textarea.value.trim();
    
    if (!text) {
        showStatus(callStatusEl, '–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∫–æ–¥ –∑–≤–æ–Ω–∫–∞!', 'error');
        return;
    }
    
    try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π API
        await navigator.clipboard.writeText(text);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        copyHint.innerHTML = '‚úÖ <strong>–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</strong> –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –¥—Ä—É–≥—É —á–µ—Ä–µ–∑ Telegram, WhatsApp –∏–ª–∏ –ª—é–±—ã–º –¥—Ä—É–≥–∏–º —Å–ø–æ—Å–æ–±–æ–º.';
        copyHint.style.color = '#48bb78';
        
        addLog('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
        playSound('copy');
        
        // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –Ω–∞ 3 —Å–µ–∫—É–Ω–¥—ã
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        copyBtn.disabled = true;
        
        setTimeout(() => {
            copyBtn.innerHTML = originalText;
            copyBtn.disabled = false;
        }, 3000);
        
    } catch (error) {
        // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        textarea.select();
        textarea.setSelectionRange(0, 99999);
        document.execCommand('copy');
        
        copyHint.innerHTML = '‚úÖ <strong>–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</strong> (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω fallback –º–µ—Ç–æ–¥)';
        addLog('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω (fallback –º–µ—Ç–æ–¥)', 'warning');
    }
}

// 6. –í—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
async function pasteAnswer() {
    if (!isCaller) {
        showStatus(callStatusEl, '–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–æ–≥–æ, –∫—Ç–æ –Ω–∞—á–∞–ª –∑–≤–æ–Ω–æ–∫', 'error');
        return;
    }
    
    if (!peerConnection) {
        showStatus(callStatusEl, '–°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ –∑–≤–æ–Ω–æ–∫!', 'error');
        return;
    }
    
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const answerString = prompt('üìã –í—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–≤–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤–∞–º –æ—Ç–ø—Ä–∞–≤–∏–ª –¥—Ä—É–≥:');
    if (!answerString) {
        addLog('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –≤–≤–æ–¥', 'warning');
        return;
    }
    
    try {
        const answer = JSON.parse(answerString);
        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        
        showStatus(callStatusEl, '‚úÖ –û—Ç–≤–µ—Ç –ø—Ä–∏–Ω—è—Ç! –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...', 'success');
        addLog('–û—Ç–≤–µ—Ç –¥—Ä—É–≥–∞ –ø—Ä–∏–Ω—è—Ç, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...', 'info');
        updateConnectionStatus(false, '–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...');
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ
        document.getElementById('offerData').value = '';
        dataHint.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...';
        
    } catch (error) {
        showStatus(callStatusEl, `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        addLog(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞: ${error.message}`, 'error');
    }
}

// 7. –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
function playSound(type) {
    try {
        if (type === 'success') {
            // –ö–æ—Ä–æ—Ç–∫–∏–π –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –∑–≤—É–∫
            const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==');
            audio.volume = 0.3;
            audio.play();
        } else if (type === 'copy') {
            // –ó–≤—É–∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==');
            audio.volume = 0.2;
            audio.play();
        } else if (type === 'connection') {
            // –ó–≤—É–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==');
            audio.volume = 0.4;
            audio.play();
        }
    } catch (e) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∑–≤—É–∫–∞
    }
}

// 8. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load', () => {
    addLog('–°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞', 'system');
    addLog('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome –∏–ª–∏ Firefox –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏', 'system');
    addLog('–ù–∞–∂–º–∏—Ç–µ "–í–∫–ª—é—á–∏—Ç—å –º–æ—é –∫–∞–º–µ—Ä—É" –¥–ª—è –Ω–∞—á–∞–ª–∞', 'system');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É WebRTC
    if (!window.RTCPeerConnection) {
        showStatus(cameraStatusEl, '‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebRTC! –û–±–Ω–æ–≤–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä.', 'error');
        addLog('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebRTC', 'error');
    }
});

// 9. –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
function resetConnection() {
    if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
    }
    
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    
    document.getElementById('remoteVideo').srcObject = null;
    document.getElementById('offerData').value = '';
    
    callBtn.disabled = true;
    answerBtn.disabled = true;
    copyBtn.disabled = true;
    pasteBtn.disabled = true;
    
    updateConnectionStatus(false, '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ');
    addLog('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ', 'system');
}

// –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞
const resetBtn = document.createElement('button');
resetBtn.className = 'btn btn-secondary';
resetBtn.innerHTML = 'üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ';
resetBtn.onclick = resetConnection;
resetBtn.style.marginTop = '20px';

document.querySelector('.controls').appendChild(resetBtn);

// –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
const instructions = document.createElement('div');
instructions.innerHTML = `
    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-top: 30px; color: white;">
        <h3 style="color: white; margin-bottom: 15px;">üìñ –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:</h3>
        <ol style="line-height: 1.8;">
            <li><strong>–ù–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ 1:</strong> "–í–∫–ª—é—á–∏—Ç—å –º–æ—é –∫–∞–º–µ—Ä—É" ‚Üí "–Ø –∑–≤–æ–Ω—é" ‚Üí –ö–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–æ–ø–∏—Ä—É–µ—Ç—Å—è</li>
            <li><strong>–ù–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ 2:</strong> "–í–∫–ª—é—á–∏—Ç—å –º–æ—é –∫–∞–º–µ—Ä—É" ‚Üí "–ú–Ω–µ –∑–≤–æ–Ω—è—Ç" ‚Üí –í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ 1</li>
            <li><strong>–ù–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ 2:</strong> –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–æ–ø–∏—Ä—É–µ—Ç—Å—è ‚Üí –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 1</li>
            <li><strong>–ù–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ 1:</strong> –ù–∞–∂–º–∏—Ç–µ "–í—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç" ‚Üí –í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ 2</li>
            <li><strong>–ì–æ—Ç–æ–≤–æ!</strong> –í–∏–¥–µ–æ –ø–æ—è–≤–∏—Ç—Å—è —Å–ø—Ä–∞–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
        </ol>
    </div>
`;

document.querySelector('.container').appendChild(instructions);
</script>
</body>
</html>
