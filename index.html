<!DOCTYPE html>
<html>
<head>
    <title>–°—É–ø–µ—Ä-–ø—Ä–æ—Å—Ç–æ–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        video { width: 300px; height: 225px; border: 2px solid #333; margin: 10px; }
        .container { display: flex; flex-wrap: wrap; }
        button { 
            padding: 15px; 
            margin: 10px; 
            font-size: 18px; 
            background: #4CAF50; 
            color: white; 
            border: none; 
            cursor: pointer; 
        }
        .debug { background: #f0f0f0; padding: 10px; margin-top: 20px; }
        #qrcode { margin: 20px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
    <h1>üîç –ü—Ä–æ—Å—Ç–æ–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</h1>
    
    <div class="container">
        <div>
            <h3>–í–∞—à–∞ –∫–∞–º–µ—Ä–∞:</h3>
            <video id="localVideo" autoplay muted playsinline></video>
            <div id="localStatus"></div>
        </div>
        <div>
            <h3>–î—Ä—É–≥:</h3>
            <video id="remoteVideo" autoplay playsinline></video>
            <div id="remoteStatus"></div>
        </div>
    </div>
    
    <div>
        <button onclick="startSimpleCall()">1. –°–¢–ê–†–¢ (–Ø –∑–≤–æ–Ω—é)</button>
        <button onclick="answerSimpleCall()">2. –û–¢–í–ï–¢ (–ú–Ω–µ –∑–≤–æ–Ω—è—Ç)</button>
    </div>
    
    <div id="qrcode"></div>
    
    <div class="debug">
        <h3>–û—Ç–ª–∞–¥–∫–∞:</h3>
        <div id="debugLog"></div>
    </div>

<script>
let localStream;
let peerConnection;
let isCaller = false;
const debug = document.getElementById('debugLog');

function log(msg) {
    debug.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${msg}</div>`;
    console.log(msg);
}

// 1. –ü–†–û–í–ï–†–ö–ê –ö–ê–ú–ï–†–´
async function checkCamera() {
    try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');
        log(`–ù–∞–π–¥–µ–Ω–æ –∫–∞–º–µ—Ä: ${videoDevices.length}`);
        
        if (videoDevices.length === 0) {
            alert("‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.");
            return false;
        }
        return true;
    } catch (e) {
        log("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–º–µ—Ä—ã: " + e);
        return false;
    }
}

// 2. –ó–ê–ü–£–°–ö –ö–ê–ú–ï–†–´
async function startCamera() {
    try {
        log("–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...");
        localStream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: "user"
            },
            audio: false
        });
        
        document.getElementById('localVideo').srcObject = localStream;
        document.getElementById('localStatus').innerHTML = "‚úÖ –ö–∞–º–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç";
        log("‚úÖ –ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞");
        return true;
    } catch (e) {
        log("‚ùå –û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: " + e.message);
        alert("–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞!");
        return false;
    }
}

// 3. –ü–†–û–°–¢–û–ô –ó–í–û–ù–û–ö (–Ø –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä)
async function startSimpleCall() {
    log("=== –Ø –ò–ù–ò–¶–ò–ê–¢–û–† ===");
    isCaller = true;
    
    if (!await checkCamera()) return;
    if (!await startCamera()) return;
    
    // –°–æ–∑–¥–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    createPeerConnection();
    
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
    try {
        const offer = await peerConnection.createOffer({
            offerToReceiveVideo: true,
            offerToReceiveAudio: false
        });
        await peerConnection.setLocalDescription(offer);
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ—Ä–æ—Ç–∫—É—é —Å—Å—ã–ª–∫—É
        const offerData = btoa(JSON.stringify(offer));
        const link = `${window.location.origin}${window.location.pathname}#${offerData}`;
        
        log("‚úÖ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ");
        log("–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –¥—Ä—É–≥—É:");
        log(link);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º QR-–∫–æ–¥
        QRCode.toCanvas(document.getElementById('qrcode'), link, function (error) {
            if (error) console.error(error);
        });
        
        // –ñ–¥–µ–º –æ—Ç–≤–µ—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ URL hash
        waitForAnswerInHash();
        
    } catch (e) {
        log("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: " + e);
    }
}

// 4. –ü–†–ò–ù–Ø–¢–¨ –ó–í–û–ù–û–ö (–Ø –ø–æ–ª—É—á–∞—Ç–µ–ª—å)
async function answerSimpleCall() {
    log("=== –Ø –ü–û–õ–£–ß–ê–¢–ï–õ–¨ ===");
    isCaller = false;
    
    if (!await checkCamera()) return;
    if (!await startCamera()) return;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤ URL
    const hash = window.location.hash.substring(1);
    if (hash) {
        log("–ù–∞–π–¥–µ–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤ —Å—Å—ã–ª–∫–µ");
        await processOfferFromHash(hash);
    } else {
        log("–ñ–¥—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ...");
        // –ñ–¥–µ–º –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å—Ç–∞–≤–∏—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
        const offerText = prompt("–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ —Ç–µ–∫—Å—Ç –æ—Ç –¥—Ä—É–≥–∞:");
        if (offerText) {
            await processOffer(offerText);
        }
    }
}

// 5. –û–ë–†–ê–ë–û–¢–ê–¢–¨ –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï
async function processOffer(offerData) {
    try {
        let offer;
        // –ï—Å–ª–∏ —ç—Ç–æ base64 –≤ —Å—Å—ã–ª–∫–µ
        if (offerData.startsWith('ey')) { // JSON –≤ base64
            offer = JSON.parse(atob(offerData));
        } else if (offerData.startsWith('{')) { // JSON –Ω–∞–ø—Ä—è–º—É—é
            offer = JSON.parse(offerData);
        } else {
            // –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –∏–∑ —Å—Å—ã–ª–∫–∏
            const match = offerData.match(/#(.+)$/);
            if (match) {
                offer = JSON.parse(atob(match[1]));
            }
        }
        
        log("–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ");
        
        createPeerConnection();
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        
        // –°–æ–∑–¥–∞–µ–º –æ—Ç–≤–µ—Ç
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        
        // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É —Å –æ—Ç–≤–µ—Ç–æ–º
        const answerData = btoa(JSON.stringify(answer));
        const answerLink = `${window.location.origin}${window.location.pathname}#answer=${answerData}`;
        
        log("‚úÖ –û—Ç–≤–µ—Ç —Å–æ–∑–¥–∞–Ω");
        log("–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –æ–±—Ä–∞—Ç–Ω–æ:");
        log(answerLink);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º QR-–∫–æ–¥ —Å –æ—Ç–≤–µ—Ç–æ–º
        QRCode.toCanvas(document.getElementById('qrcode'), answerLink, function (error) {
            if (error) console.error(error);
        });
        
    } catch (e) {
        log("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: " + e);
    }
}

// 6. –û–ñ–ò–î–ê–ù–ò–ï –û–¢–í–ï–¢–ê –í URL (–¥–ª—è –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞)
function waitForAnswerInHash() {
    function checkHash() {
        const hash = window.location.hash;
        if (hash.includes('answer=')) {
            log("–ù–∞–π–¥–µ–Ω –æ—Ç–≤–µ—Ç –≤ —Å—Å—ã–ª–∫–µ!");
            const answerData = hash.split('=')[1];
            processAnswer(answerData);
        } else {
            setTimeout(checkHash, 1000);
        }
    }
    checkHash();
}

// 7. –û–ë–†–ê–ë–û–¢–ê–¢–¨ –û–¢–í–ï–¢
async function processAnswer(answerData) {
    try {
        const answer = JSON.parse(atob(answerData));
        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        log("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!");
        document.getElementById('remoteStatus').innerHTML = "‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–æ";
    } catch (e) {
        log("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞: " + e);
    }
}

// 8. –û–ë–†–ê–ë–û–¢–ê–¢–¨ –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï –ò–ó HASH
async function processOfferFromHash(hash) {
    if (hash.startsWith('answer=')) {
        // –≠—Ç–æ –æ—Ç–≤–µ—Ç, –∞ –Ω–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
        const answerData = hash.split('=')[1];
        if (isCaller) {
            await processAnswer(answerData);
        }
        return;
    }
    
    // –≠—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
    await processOffer(hash);
}

// 9. –°–û–ó–î–ê–¢–¨ –°–û–ï–î–ò–ù–ï–ù–ò–ï WebRTC
function createPeerConnection() {
    try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–µ STUN —Å–µ—Ä–≤–µ—Ä—ã Google
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' }
            ]
        };
        
        log("–°–æ–∑–¥–∞—é WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...");
        peerConnection = new RTCPeerConnection(config);
        
        // –î–æ–±–∞–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
        if (localStream) {
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
        }
        
        // –ü–æ–ª—É—á–∏—Ç—å –≤–∏–¥–µ–æ –æ—Ç –¥—Ä—É–≥–∞
        peerConnection.ontrack = (event) => {
            log("–ü–æ–ª—É—á–∞—é –≤–∏–¥–µ–æ –æ—Ç –¥—Ä—É–≥–∞...");
            if (!document.getElementById('remoteVideo').srcObject) {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
                log("‚úÖ –í–∏–¥–µ–æ –¥—Ä—É–≥–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ!");
            }
        };
        
        // –û—Ç–ª–∞–¥–∫–∞ ICE
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                log("ICE –∫–∞–Ω–¥–∏–¥–∞—Ç: " + event.candidate.candidate.substring(0, 50));
            } else {
                log("‚úÖ ICE —Å–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
            }
        };
        
        peerConnection.oniceconnectionstatechange = () => {
            log(`ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${peerConnection.iceConnectionState}`);
        };
        
        peerConnection.onsignalingstatechange = () => {
            log(`Signaling —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${peerConnection.signalingState}`);
        };
        
    } catch (e) {
        log("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: " + e);
    }
}

// 10. –ê–í–¢–û–ü–†–û–í–ï–†–ö–ê –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
window.addEventListener('load', async () => {
    log("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
    log(`–ë—Ä–∞—É–∑–µ—Ä: ${navigator.userAgent}`);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º WebRTC –ø–æ–¥–¥–µ—Ä–∂–∫—É
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebRTC!\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome, Firefox –∏–ª–∏ Edge");
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–º–µ—Ä—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    await checkCamera();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö
    const hash = window.location.hash.substring(1);
    if (hash) {
        log("–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –≤ URL");
        if (hash.startsWith('answer=')) {
            log("–≠—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ –∑–≤–æ–Ω–æ–∫");
        } else {
            log("–≠—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞");
        }
    }
});

// 11. –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –°–°–´–õ–ö–ò –í –ë–£–§–ï–†
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        log("‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
    });
}
</script>

<div style="margin-top: 30px; padding: 15px; background: #e3f2fd; border-radius: 10px;">
    <h3>üìã –ö–ê–ö –ü–û–õ–¨–ó–û–í–ê–¢–¨–°–Ø (–ø—Ä–æ—â–µ –Ω–µ–∫—É–¥–∞):</h3>
    <ol>
        <li><strong>–ù–∞ –ü–ï–†–í–û–ú —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ:</strong> –ù–∞–∂–º–∏ "1. –°–¢–ê–†–¢" ‚Üí –†–∞–∑—Ä–µ—à–∏ –∫–∞–º–µ—Ä—É ‚Üí <strong>–û—Ç–ø—Ä–∞–≤—å QR-–∫–æ–¥ –¥—Ä—É–≥—É</strong> (—Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π —ç–∫—Ä–∞–Ω)</li>
        <li><strong>–ù–∞ –í–¢–û–†–û–ú —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ:</strong> –ù–∞–∂–º–∏ "2. –û–¢–í–ï–¢" ‚Üí –†–∞–∑—Ä–µ—à–∏ –∫–∞–º–µ—Ä—É ‚Üí <strong>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π QR-–∫–æ–¥</strong> –∫–∞–º–µ—Ä–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω–∞</li>
        <li><strong>–í–µ—Ä–Ω–∏—Å—å –Ω–∞ –ø–µ—Ä–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</strong> –∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π QR-–∫–æ–¥ –æ—Ç –≤—Ç–æ—Ä–æ–≥–æ</li>
        <li><strong>–ì–û–¢–û–í–û! –í–∏–¥–µ–æ—Å–≤—è–∑—å —Ä–∞–±–æ—Ç–∞–µ—Ç! –∏ —Å–æ–∑–¥–∞—Ç–µ–ª—å CryptoCat</strong></li>
    </ol>
    <p style="color: #d32f2f; font-weight: bold;">
        ‚ö†Ô∏è –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: 1) –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞–º–µ—Ä—É 2) –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–¥–∏–Ω –±—Ä–∞—É–∑–µ—Ä (Chrome –ª—É—á—à–µ –≤—Å–µ–≥–æ) 3) –ë—É–¥—å—Ç–µ –≤ –æ–¥–Ω–æ–π —Å–µ—Ç–∏ Wi-Fi
    </p>
</div>

</body>
</html>
